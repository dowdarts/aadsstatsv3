<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AADS Admin - Player Management | LOCAL ONLY</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <header class="main-header">
        <div class="header-content">
            <div class="logo-section">
                <img src="../assets/logos/Official AADS Logo.png" alt="AADS Logo" class="main-logo">
            </div>
            <nav class="main-nav">
                <button class="nav-tab" onclick="window.location.href='admin-qualifier.html'">Qualifier Events</button>
                <button class="nav-tab" onclick="window.location.href='admin-toc.html'">TOC Event</button>
                <button class="nav-tab active" onclick="window.location.href='admin-players.html'">Manage Players</button>
            </nav>
        </div>
    </header>

    <main class="container">
        <h1 class="page-title">⚠️ ADMIN - Player Management (LOCAL ONLY)</h1>

        <!-- ADD NEW PLAYER -->
        <div class="section-card">
            <h2 class="section-title">Add New Player</h2>
            <div class="form-grid">
                <div>
                    <label>Player Name *</label>
                    <input type="text" id="newPlayerName" class="form-input" placeholder="Full Name">
                </div>
                <div>
                    <label>Hometown</label>
                    <input type="text" id="newPlayerHometown" class="form-input" placeholder="City, State">
                </div>
            </div>
            <div>
                <label>Bio</label>
                <textarea id="newPlayerBio" class="form-input" rows="3" placeholder="Player biography..."></textarea>
            </div>
            <div>
                <label>Player Photo</label>
                <input type="file" id="newPlayerPhoto" class="form-input" accept="image/*">
            </div>
            <button class="btn-primary" onclick="addPlayer()">+ Add Player</button>
        </div>

        <!-- EDIT EXISTING PLAYER -->
        <div class="section-card">
            <h2 class="section-title">Edit Player</h2>
            <div class="autocomplete-container">
                <label>Search Player</label>
                <input type="text" id="searchPlayerInput" class="form-input" placeholder="Type player name...">
                <div id="searchSuggestions" class="autocomplete-suggestions"></div>
            </div>
            
            <div id="editForm" style="display: none; margin-top: 20px;">
                <div class="form-grid">
                    <div>
                        <label>Player Name *</label>
                        <input type="text" id="editPlayerName" class="form-input">
                    </div>
                    <div>
                        <label>Hometown</label>
                        <input type="text" id="editPlayerHometown" class="form-input">
                    </div>
                </div>
                <div>
                    <label>Bio</label>
                    <textarea id="editPlayerBio" class="form-input" rows="3"></textarea>
                </div>
                <div>
                    <label>Replace Photo</label>
                    <input type="file" id="editPlayerPhoto" class="form-input" accept="image/*">
                    <img id="currentPhoto" src="" alt="Current Photo" style="max-width: 150px; margin-top: 10px; display: none;">
                </div>
                <div class="form-grid">
                    <button class="btn-primary" onclick="updatePlayer()">Save Changes</button>
                    <button class="btn-secondary" onclick="cancelEdit()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- PLAYER LIST -->
        <div class="section-card">
            <h2 class="section-title">All Players</h2>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Hometown</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="playerList">
                    <tr><td colspan="3" class="text-center">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <script src="../js/app.js"></script>
    <script>
        let allPlayers = [];
        let selectedPlayer = null;
        let autocomplete;

        document.addEventListener('DOMContentLoaded', async () => {
            await loadPlayers();
        });

        async function loadPlayers() {
            allPlayers = await AADS.fetchPlayers();
            
            autocomplete = new AADS.Autocomplete('searchPlayerInput', 'searchSuggestions', allPlayers, player => {
                selectPlayerForEdit(player);
            });

            displayPlayerList();
        }

        function displayPlayerList() {
            document.getElementById('playerList').innerHTML = allPlayers.map(p => `
                <tr>
                    <td>${p.name}</td>
                    <td>${p.hometown || '-'}</td>
                    <td>
                        <button class="btn-secondary" onclick="selectPlayerForEdit({id: ${p.id}, name: '${p.name}', hometown: '${p.hometown || ''}', bio: '${(p.bio || '').replace(/'/g, "\\'")}', photo_url: '${p.photo_url || ''}'})">Edit</button>
                    </td>
                </tr>
            `).join('');
        }

        function selectPlayerForEdit(player) {
            selectedPlayer = player;
            document.getElementById('editForm').style.display = 'block';
            document.getElementById('editPlayerName').value = player.name;
            document.getElementById('editPlayerHometown').value = player.hometown || '';
            document.getElementById('editPlayerBio').value = player.bio || '';
            
            if (player.photo_url) {
                document.getElementById('currentPhoto').src = player.photo_url;
                document.getElementById('currentPhoto').style.display = 'block';
            } else {
                document.getElementById('currentPhoto').style.display = 'none';
            }
        }

        function cancelEdit() {
            selectedPlayer = null;
            document.getElementById('editForm').style.display = 'none';
            document.getElementById('searchPlayerInput').value = '';
        }

        async function addPlayer() {
            const name = document.getElementById('newPlayerName').value.trim();
            
            if (!name) {
                alert('Player name is required');
                return;
            }

            const hometown = document.getElementById('newPlayerHometown').value.trim();
            const bio = document.getElementById('newPlayerBio').value.trim();
            const photoFile = document.getElementById('newPlayerPhoto').files[0];

            let photoUrl = null;

            if (photoFile) {
                photoUrl = await uploadPhoto(photoFile, name);
            }

            await AADS.adminRequest('insert', 'players', {
                name,
                hometown: hometown || null,
                bio: bio || null,
                photo_url: photoUrl
            });

            alert('Player added successfully!');
            
            document.getElementById('newPlayerName').value = '';
            document.getElementById('newPlayerHometown').value = '';
            document.getElementById('newPlayerBio').value = '';
            document.getElementById('newPlayerPhoto').value = '';
            
            await loadPlayers();
        }

        async function updatePlayer() {
            if (!selectedPlayer) return;

            const name = document.getElementById('editPlayerName').value.trim();
            
            if (!name) {
                alert('Player name is required');
                return;
            }

            const hometown = document.getElementById('editPlayerHometown').value.trim();
            const bio = document.getElementById('editPlayerBio').value.trim();
            const photoFile = document.getElementById('editPlayerPhoto').files[0];

            let photoUrl = selectedPlayer.photo_url;

            if (photoFile) {
                photoUrl = await uploadPhoto(photoFile, name);
            }

            await AADS.adminRequest('update', 'players', {
                id: selectedPlayer.id,
                name,
                hometown: hometown || null,
                bio: bio || null,
                photo_url: photoUrl
            });

            alert('Player updated successfully!');
            cancelEdit();
            await loadPlayers();
        }

        async function uploadPhoto(file, playerName) {
            const fileExt = file.name.split('.').pop();
            const fileName = `${playerName.replace(/\s+/g, '_')}_${Date.now()}.${fileExt}`;
            
            const { data, error } = await AADS.supabase.storage
                .from('player-photos')
                .upload(fileName, file);

            if (error) {
                console.error('Upload error:', error);
                alert('Failed to upload photo. See console for details.');
                return null;
            }

            const { data: urlData } = AADS.supabase.storage
                .from('player-photos')
                .getPublicUrl(fileName);

            return urlData.publicUrl;
        }
    </script>
</body>
</html>
