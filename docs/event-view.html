<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AADS - Event View | Atlantic Amateur Darts Series</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <header class="main-header">
        <div class="header-content">
            <div class="logo-section">
                <a href="index.html">
                    <img src="../assets/logos/Official AADS Logo.png" alt="AADS Logo" class="main-logo">
                </a>
                <div class="sponsor-logos">
                    <a href="https://cgcdarts.com" target="_blank"><img src="../assets/logos/CGCDARTS-COM IMPROVED LOGO.png" alt="CGC Darts" class="sponsor-logo"></a>
                    <a href="https://aadsdarts.com" target="_blank"><img src="../assets/logos/MDstudios Logo.png" alt="MD Studios" class="sponsor-logo"></a>
                    <a href="https://share.google/n72Q5jiffuoh394fn" target="_blank"><img src="../assets/logos/CGCTV logo.png" alt="CGC TV" class="sponsor-logo"></a>
                </div>
            </div>
            <nav class="main-nav">
                <button class="nav-tab" onclick="window.location.href='index.html'">All-Time Stats</button>
                <button class="nav-tab" onclick="window.location.href='series-view.html'">Series</button>
                <button class="nav-tab" onclick="window.location.href='players-directory.html'">Players Directory</button>
                <button class="nav-tab" onclick="window.location.href='head-to-head.html'">Head-to-Head</button>
            </nav>
        </div>
    </header>

    <div class="breadcrumb-section">
        <div class="breadcrumb" id="breadcrumb"></div>
        <button class="back-button" onclick="AADS.navHistory.goBack()">‚Üê Back</button>
    </div>

    <main class="container">
        <h1 class="page-title" id="eventTitle">Event Loading...</h1>

        <!-- GROUP STAGE (Qualifiers only) -->
        <div id="groupStage" style="display: none;">
            <div class="section-card">
                <h2 class="section-title">Group A Standings</h2>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>Pos</th>
                            <th>Player</th>
                            <th>Matches</th>
                            <th>Leg Wins</th>
                            <th>Leg Losses</th>
                            <th>+/-</th>
                        </tr>
                    </thead>
                    <tbody id="groupA"></tbody>
                </table>
            </div>

            <div class="section-card">
                <h2 class="section-title">Group B Standings</h2>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>Pos</th>
                            <th>Player</th>
                            <th>Matches</th>
                            <th>Leg Wins</th>
                            <th>Leg Losses</th>
                            <th>+/-</th>
                        </tr>
                    </thead>
                    <tbody id="groupB"></tbody>
                </table>
            </div>
        </div>

        <!-- TOC SINGLE GROUP -->
        <div id="tocGroup" style="display: none;">
            <div class="section-card">
                <h2 class="section-title">Round Robin Standings</h2>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>Pos</th>
                            <th>Player</th>
                            <th>Matches</th>
                            <th>Leg Wins</th>
                            <th>Leg Losses</th>
                            <th>+/-</th>
                        </tr>
                    </thead>
                    <tbody id="tocGroupTable"></tbody>
                </table>
            </div>
        </div>

        <!-- KNOCKOUT BRACKET -->
        <div class="section-card">
            <h2 class="section-title">Knockout Stage</h2>
            <div class="bracket-container" id="bracket">
                <p class="text-center">Loading bracket...</p>
            </div>
        </div>
    </main>

    <script src="js/app.js"></script>
    <script>
        let eventId = null;
        let event = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            eventId = params.get('id');
            
            if (!eventId) {
                window.location.href = 'index.html';
                return;
            }

            await loadEvent();
        });

        async function loadEvent() {
            const { data } = await AADS.supabase
                .from('events')
                .select('*, series:series_id(series_name), winner:winner_id(name)')
                .eq('id', eventId)
                .single();

            if (!data) {
                alert('Event not found');
                window.location.href = 'index.html';
                return;
            }

            event = data;

            document.getElementById('breadcrumb').innerHTML = `
                <a href="index.html">Home</a> > 
                <a href="series-view.html">${event.series.series_name}</a> > 
                <span>Event ${event.event_number}${event.is_toc ? ' (TOC)' : ''}</span>
            `;

            document.getElementById('eventTitle').textContent = 
                `${event.series.series_name} - Event ${event.event_number}${event.is_toc ? ' (Tournament of Champions)' : ''}`;

            if (event.is_toc) {
                await loadTOCGroup();
                document.getElementById('tocGroup').style.display = 'block';
            } else {
                await loadGroups();
                document.getElementById('groupStage').style.display = 'block';
            }

            await loadBracket();
        }

        async function loadGroups() {
            const standings = await AADS.calculateGroupStandings(eventId);
            
            const groupA = standings.filter(s => s.group === 'A');
            const groupB = standings.filter(s => s.group === 'B');

            document.getElementById('groupA').innerHTML = groupA.map((s, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td class="player-name" onclick="window.location.href='player-profile.html?id=${s.player_id}'">${s.player_name}</td>
                    <td>${s.matches_played}</td>
                    <td>${s.leg_wins}</td>
                    <td>${s.leg_losses}</td>
                    <td>${s.leg_difference > 0 ? '+' : ''}${s.leg_difference}</td>
                </tr>
            `).join('');

            document.getElementById('groupB').innerHTML = groupB.map((s, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td class="player-name" onclick="window.location.href='player-profile.html?id=${s.player_id}'">${s.player_name}</td>
                    <td>${s.matches_played}</td>
                    <td>${s.leg_wins}</td>
                    <td>${s.leg_losses}</td>
                    <td>${s.leg_difference > 0 ? '+' : ''}${s.leg_difference}</td>
                </tr>
            `).join('');
        }

        async function loadTOCGroup() {
            const standings = await AADS.calculateGroupStandings(eventId);
            
            document.getElementById('tocGroupTable').innerHTML = standings.map((s, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td class="player-name" onclick="window.location.href='player-profile.html?id=${s.player_id}'">${s.player_name}</td>
                    <td>${s.matches_played}</td>
                    <td>${s.leg_wins}</td>
                    <td>${s.leg_losses}</td>
                    <td>${s.leg_difference > 0 ? '+' : ''}${s.leg_difference}</td>
                </tr>
            `).join('');
        }

        async function loadBracket() {
            const { data: matches } = await AADS.supabase
                .from('matches')
                .select('*, p1:player_1_id(name), p2:player_2_id(name), winner:winner_id(name)')
                .eq('event_id', eventId)
                .eq('stage', 'knockout')
                .order('round');

            if (!matches || matches.length === 0) {
                document.getElementById('bracket').innerHTML = '<p class="text-center">Knockout stage not started</p>';
                return;
            }

            const qf = matches.filter(m => m.round === 'Quarter-Final');
            const sf = matches.filter(m => m.round === 'Semi-Final');
            const f = matches.filter(m => m.round === 'Final');

            document.getElementById('bracket').innerHTML = `
                <div class="bracket-round">
                    <h3>Quarter-Finals</h3>
                    ${qf.map(m => renderMatch(m)).join('')}
                </div>
                <div class="bracket-round">
                    <h3>Semi-Finals</h3>
                    ${sf.map(m => renderMatch(m)).join('')}
                </div>
                <div class="bracket-round">
                    <h3>Final</h3>
                    ${f.map(m => renderMatch(m)).join('')}
                </div>
            `;
        }

        function renderMatch(match) {
            return `
                <div class="bracket-match ${match.winner_id ? 'completed' : ''}">
                    <div class="bracket-player ${match.winner_id === match.player_1_id ? 'winner' : ''}">
                        <span class="player-name" onclick="window.location.href='player-profile.html?id=${match.player_1_id}'">${match.p1.name}</span>
                        <span>${match.p1_legs || 0}</span>
                    </div>
                    <div class="bracket-player ${match.winner_id === match.player_2_id ? 'winner' : ''}">
                        <span class="player-name" onclick="window.location.href='player-profile.html?id=${match.player_2_id}'">${match.p2.name}</span>
                        <span>${match.p2_legs || 0}</span>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
